**用户：** 在 `/Users/lord/WiseNET/个人收纳物品整理/ai-inventory-app/2.后台Python/v3_upload_image.py` 在接口调用的最开始增加一个限制。查询下用户当前所有的物品个数，然后看下这个item_limit，如果没有达到限制，则正常保存。 如果超过了限制，不要保存，不要占用服务器资源，直接给前端返回一个错误提示（200的状态码）。

**智能体：** 我已经为v3_upload_image.py接口添加了物品数量限制检查功能。

## 实现的功能

### 1. 新增检查函数：check_user_item_limit()
- 查询用户的item_limit限制
- 统计用户当前所有物品数量（通过items_detail表关联查询）
- 比较当前物品数量与限制数量
- 如果超过限制，返回200状态码和详细错误信息
- 如果未超过限制，返回用户信息和剩余额度

### 2. 接口调用流程优化
在图片上传接口中，按以下顺序执行：
1. 验证用户是否存在
2. **立即检查物品数量限制**（新增）
3. 验证文件类型
4. 后续的图片处理和AI分析

### 3. 错误返回格式
当物品数量超过限制时，返回：
```json
{
  "status": "error",
  "message": "物品数量已达到上限！当前已有X个物品，限制为Y个。请观看广告获取更多存储额度。",
  "data": {
    "current_item_count": 当前物品数量,
    "item_limit": 限制数量,
    "remaining_slots": 0,
    "need_watch_ad": true
  }
}
```

## 优势

- **节省服务器资源**：在处理图片压缩和AI分析之前就进行检查
- **用户体验友好**：返回200状态码和详细提示信息
- **引导用户行为**：提示用户观看广告获取更多额度
- **数据准确性**：通过关联查询确保统计准确

这样的实现确保了在用户达到物品存储限制时，不会浪费服务器资源进行图片处理和AI分析，同时为用户提供清晰的反馈和解决方案。